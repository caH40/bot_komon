import {
	mainMenuKeyboard,
	teamKeyboard,
	teamLeaveKeyboard,
	teamManagementKeyboard,
	teamRemoveRiderKeyboard,
	teamsKeyboard,
} from '../../keyboard/keyboard.js';
import { Rider } from '../../Model/Rider.js';
import { Team } from '../../Model/Team.js';

export async function teamMain(ctx) {
	try {
		const userId = ctx.update.callback_query.message.chat.id;
		const riderDB = await Rider.findOne({ telegramId: userId }).populate('teamId');
		if (!riderDB)
			return await ctx.replyWithHTML('–î–ª—è —ç—Ç–æ–≥–æ –º–µ–Ω—é –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ <b>—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è!</b> üÜî');

		let title = riderDB.teamId?.name
			? `–ö–æ–º–∞–Ω–¥–∞ "${riderDB.teamId?.name}" üí™`
			: 'ü§ù –ü–æ—Ä–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è—Ç—å—Å—è –∫ –∫–æ–º–∞–Ω–¥–µ –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å —Å–≤–æ—é!';

		return await ctx.editMessageText(`<b>${title}</b>`, await teamKeyboard(riderDB));
	} catch (error) {
		console.log(error);
	}
}
export async function teamChooseForJoin(ctx, cbqData) {
	try {
		const teamId = cbqData.slice(24);
		const userId = ctx.update.callback_query.from.id;

		const riderDB = await Rider.findOneAndUpdate(
			{ telegramId: userId },
			{ $set: { teamId: teamId } },
			{ returnDocument: 'after' }
		);
		if (riderDB.teamId) {
			await ctx
				.reply('–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–∞–Ω–¥–µ!')
				.then(message => ctx.session.data.messagesIdForDelete.push(message.message_id));
		} else {
			await ctx
				.retry(
					'–ß—Ç–æ —Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.'
				)
				.then(message => ctx.session.data.messagesIdForDelete.push(message.message_id));
		}
		return await ctx.editMessageText(
			`‚ùó<b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é. –í—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π.</b>‚ùó\n<i>main</i>`,
			await mainMenuKeyboard(ctx)
		);
	} catch (error) {
		console.log(error);
	}
}

export async function teamJoin(ctx) {
	try {
		const teamDB = await Team.find({ isAllowed: true });
		if (teamDB.length === 0)
			return await ctx
				.replyWithHTML('–û—á–µ–Ω—å —Å—Ç—Ä–∞–Ω–Ω–æ, –Ω–µ —Å–æ–∑–¥–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã ü§∑‚Äç‚ôÇÔ∏è')
				.then(message => ctx.session.data.messagesIdForDelete.push(message.message_id));

		return await ctx.editMessageText(
			`<b>üìå –°–ø–∏—Å–æ–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥</b>`,
			teamsKeyboard(teamDB)
		);
	} catch (error) {
		console.log(error);
	}
}

export async function teamCreate(ctx) {
	try {
		await ctx.editMessageText(
			`‚ùó<b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é. –í—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π.</b>‚ùó\n<i>main</i>`,
			await mainMenuKeyboard(ctx)
		);
		return await ctx.scene.enter('firstSceneCreateTeam');
	} catch (error) {
		console.log(error);
	}
}
export async function teamLeave(ctx) {
	try {
		const userId = ctx.update.callback_query.from.id;

		const riderDB = await Rider.findOne({ telegramId: userId }).populate('teamId');
		let teamName = riderDB.teamId?.name;

		return await ctx.editMessageText(
			`<b>üö™ –í—ã—Ö–æ–¥ –∏–∑ –∫–æ–º–∞–Ω–¥—ã "${teamName}"</b>`,
			teamLeaveKeyboard(riderDB._id)
		);
	} catch (error) {
		console.log(error);
	}
}
export async function teamManagement(ctx) {
	try {
		const userId = ctx.update.callback_query.from.id;

		const riderDB = await Rider.findOne({ telegramId: userId }).populate('teamId');
		let teamName = riderDB.teamId?.name;

		return await ctx.editMessageText(
			`<b>üíº –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π "${teamName}"</b>`,
			teamManagementKeyboard(riderDB._id)
		);
	} catch (error) {
		console.log(error);
	}
}
export async function teamRemoveRider(ctx) {
	try {
		const userId = ctx.update.callback_query.from.id;

		const riderDB = await Rider.findOne({ telegramId: userId }).populate('teamId');
		let teamId = riderDB.teamId?._id;
		const ridersDB = await Rider.find({ $and: [{ teamId }, { _id: { $ne: riderDB._id } }] });

		if (ridersDB.length === 0)
			return await ctx
				.reply('–í—ã –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–∞–π–¥–µ—Ä –≤ –∫–æ–º–∞–Ω–¥–µ, –í–∞–º –Ω–µ–∫–æ–≥–æ —É–¥–∞–ª—è—Ç—å –∏–∑ –∫–æ–º–∞–Ω–¥—ã!')
				.then(message => ctx.session.data.messagesIdForDelete.push(message.message_id));

		ridersDB.forEach(async rider => {
			let title = `
–†–∞–π–¥–µ—Ä: ${rider.lastName} ${rider.firstName}
–ó–≤–∏—Ñ—Ç: ${rider.lastNameZwift} ${rider.firstNameZwift}
`;
			await ctx
				.reply(title, teamRemoveRiderKeyboard(rider._id))
				.then(message => ctx.session.data.messagesIdForDelete.push(message.message_id));
		});
	} catch (error) {
		console.log(error);
	}
}
export async function teamRemove(ctx) {
	try {
		const userId = ctx.update.callback_query.from.id;
		const riderDB = await Rider.findOne({ telegramId: userId }).populate('teamId');
		const ridersDB = await Rider.find({ teamId: riderDB.teamId._id });

		if (ridersDB.length > 1)
			return await ctx
				.reply(
					'–í—ã –Ω–µ –º–æ–∂–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–æ–º–∞–Ω–¥—É, –µ—Å–ª–∏ –≤ –Ω–µ–π –µ—Å—Ç—å —Ä–∞–π–¥–µ—Ä—ã. –°–Ω–∞—á–∞–ª–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–¥–∞–ª–∏—Ç—å —Ä–∞–π–¥–µ—Ä–æ–≤ –∏–∑ –∫–æ–º–∞–Ω–¥—ã.'
				)
				.then(message => ctx.session.data.messagesIdForDelete.push(message.message_id));

		await Team.findOneAndDelete({ _id: riderDB.teamId._id }).catch(error => console.log(error));
		await Rider.findOneAndUpdate({ telegramId: userId }, { $unset: { teamId: 1 } }).catch(error =>
			console.log(error)
		);

		await ctx
			.reply(`–í—ã —É–¥–∞–ª–∏–ª–∏ –∫–æ–º–∞–Ω–¥—É "${riderDB.teamId.name}"`)
			.then(message => ctx.session.data.messagesIdForDelete.push(message.message_id));

		return await ctx.editMessageText(
			`‚ùó<b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é. –í—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π.</b>‚ùó\n<i>main</i>`,
			await mainMenuKeyboard(ctx)
		);
	} catch (error) {
		console.log(error);
	}
}
